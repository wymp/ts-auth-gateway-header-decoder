<!DOCTYPE html><html class="default no-js"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>@wymp/auth-gateway-header-decoder</title><meta name="description" content="Documentation for @wymp/auth-gateway-header-decoder"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="assets/style.css"/><link rel="stylesheet" href="assets/highlight.css"/><script async src="assets/search.js" id="search-script"></script></head><body><script>document.body.classList.add(localStorage.getItem(&quot;tsd-theme&quot;) || &quot;os&quot;)</script><header><div class="tsd-page-toolbar"><div class="container"><div class="table-wrap"><div class="table-cell" id="tsd-search" data-base="."><div class="field"><label for="tsd-search-field" class="tsd-widget search no-caption">Search</label><input type="text" id="tsd-search-field"/></div><ul class="results"><li class="state loading">Preparing search index...</li><li class="state failure">The search index is not available</li></ul><a href="index.html" class="title">@wymp/auth-gateway-header-decoder</a></div><div class="table-cell" id="tsd-widgets"><div id="tsd-filter"><a href="#" class="tsd-widget options no-caption" data-toggle="options">Options</a><div class="tsd-filter-group"><div class="tsd-select" id="tsd-filter-visibility"><span class="tsd-select-label">All</span><ul class="tsd-select-list"><li data-value="public">Public</li><li data-value="protected">Public/Protected</li><li data-value="private" class="selected">All</li></ul></div> <input type="checkbox" id="tsd-filter-inherited" checked/><label class="tsd-widget" for="tsd-filter-inherited">Inherited</label><input type="checkbox" id="tsd-filter-externals" checked/><label class="tsd-widget" for="tsd-filter-externals">Externals</label></div></div><a href="#" class="tsd-widget menu no-caption" data-toggle="menu">Menu</a></div></div></div></div><div class="tsd-page-title"><div class="container"><h1>@wymp/auth-gateway-header-decoder</h1></div></div></header><div class="container container-main"><div class="row"><div class="col-8 col-content"><div class="tsd-panel tsd-typography">
<a href="#auth-gateway-header-decoder" id="auth-gateway-header-decoder" style="color: inherit; text-decoration: none;">
  <h1>Auth Gateway Header Decoder</h1>
</a>
<p><em>A small Express middleware that decodes the auth header from a request forwarded by a
<a href="https://github.com/wymp/auth-gateway">wymp auth gateway</a> and throws an error on problems.</em></p>
<p>This library provides functionality that can be used to decode and attach auth information passed
via an auth gateway. This philosophy for managing requests and mapping them to back-end services is
more fully explained in the
<a href="https://github.com/wymp/auth-gateway#readme">wymp auth gateway readme</a>;</p>
<p>Because the header is expected to be a signed JWT, it can serve as a general authorization token
used to guarantee that requests are originating from the designated api auth gateway. On decode, the
data contained in the token represents the user and request authentication data for the request and
is attached to the <code>request</code> object as a new <code>auth</code> property. This property can be verified at
runtime using the various
<a href="https://github.com/wymp/ts-http-utils/blob/d7a65ed0f0f357d33f560577003653b86304b733/src/index.ts#L38">authd request assertion functions</a>
defined in <a href="https://github.com/wymp/ts-http-utils">@wymp/ts-http-utils</a>.</p>

<a href="#usage" id="usage" style="color: inherit; text-decoration: none;">
  <h2>Usage</h2>
</a>
<p>To use the library, simply add it as the first middleware on your app:</p>
<pre><code class="language-ts"><span class="hl-0">import</span><span class="hl-1"> </span><span class="hl-2">*</span><span class="hl-1"> </span><span class="hl-0">as</span><span class="hl-1"> </span><span class="hl-3">express</span><span class="hl-1"> </span><span class="hl-0">from</span><span class="hl-1"> </span><span class="hl-4">&quot;express&quot;</span><span class="hl-1">;</span><br/><span class="hl-0">import</span><span class="hl-1"> { </span><span class="hl-3">getAuthGatewayHeaderDecoder</span><span class="hl-1"> } </span><span class="hl-0">from</span><span class="hl-1"> </span><span class="hl-4">&quot;@wymp/auth-gateway-header-decoder&quot;</span><span class="hl-1">;</span><br/><span class="hl-0">import</span><span class="hl-1"> { </span><span class="hl-3">assertAuthdReq</span><span class="hl-1"> } </span><span class="hl-0">from</span><span class="hl-1"> </span><span class="hl-4">&quot;@wymp/http-utils&quot;</span><span class="hl-1">;</span><br/><span class="hl-0">import</span><span class="hl-1"> </span><span class="hl-2">*</span><span class="hl-1"> </span><span class="hl-0">as</span><span class="hl-1"> </span><span class="hl-3">fs</span><span class="hl-1"> </span><span class="hl-0">from</span><span class="hl-1"> </span><span class="hl-4">&quot;fs&quot;</span><span class="hl-1">;</span><br/><br/><span class="hl-2">const</span><span class="hl-1"> </span><span class="hl-5">app</span><span class="hl-1"> = </span><span class="hl-2">new</span><span class="hl-1"> </span><span class="hl-6">express</span><span class="hl-1">();</span><br/><br/><span class="hl-7">// Get the public key from somewhere for verifying requests. This could come from a file, as</span><br/><span class="hl-7">// indicated here, or it could come from an environment variable. Either way, it should be a public</span><br/><span class="hl-7">// key string compatible with the `jsonwebtoken` library.</span><br/><span class="hl-2">const</span><span class="hl-1"> </span><span class="hl-5">gatewayPubkey</span><span class="hl-1"> = </span><span class="hl-3">fs</span><span class="hl-1">.</span><span class="hl-6">readFileSync</span><span class="hl-1">(</span><span class="hl-4">&quot;./auth-gateway.pem.pub&quot;</span><span class="hl-1">).</span><span class="hl-6">toString</span><span class="hl-1">(</span><span class="hl-4">&quot;utf8&quot;</span><span class="hl-1">);</span><br/><span class="hl-3">app</span><span class="hl-1">.</span><span class="hl-6">use</span><span class="hl-1">(</span><span class="hl-6">getApiGatewayReceiver</span><span class="hl-1">(</span><span class="hl-3">gatewayPubkey</span><span class="hl-1">));</span><br/><br/><span class="hl-3">app</span><span class="hl-1">.</span><span class="hl-6">get</span><span class="hl-1">(</span><span class="hl-4">&quot;/&quot;</span><span class="hl-1">, (</span><span class="hl-3">req</span><span class="hl-1">, </span><span class="hl-3">res</span><span class="hl-1">, </span><span class="hl-3">next</span><span class="hl-1">) </span><span class="hl-2">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-7">// The middleware we used should have parsed the JWT out of the header and attached it as the</span><br/><span class="hl-1">  </span><span class="hl-7">// `auth` property on the request object. We&#39;ll use `http-util`&#39;s `assertAuthdReq` function to</span><br/><span class="hl-1">  </span><span class="hl-7">// assert this is the case. This will throw an error if the object does not conform. If it does,</span><br/><span class="hl-1">  </span><span class="hl-7">// the object will be correctly typed as an &quot;AuthdRequest&quot; (see below).</span><br/><span class="hl-1">  </span><span class="hl-6">assertAuthdReq</span><span class="hl-1">(</span><span class="hl-3">req</span><span class="hl-1">);</span><br/><br/><span class="hl-1">  </span><span class="hl-7">// Now you have an auth property on your req object</span><br/><span class="hl-1">  </span><span class="hl-7">//</span><br/><span class="hl-1">  </span><span class="hl-7">// This new property&#39;s shape is defined in [`@wymp/types`](https://github.com/wymp/ts-types/blob/c186ce316dc689cd7b913abde3ceb4bb562b7da4/src/Auth.ts#L25)</span><br/><span class="hl-1">  </span><span class="hl-7">// For convenience, it is defined as follows (read more about this via the link):</span><br/><span class="hl-1">  </span><span class="hl-7">// </span><br/><span class="hl-1">  </span><span class="hl-7">// export type ReqInfoString = {</span><br/><span class="hl-1">  </span><span class="hl-7">//     t: 0;</span><br/><span class="hl-1">  </span><span class="hl-7">//     c: string;</span><br/><span class="hl-1">  </span><span class="hl-7">//     a: boolean;</span><br/><span class="hl-1">  </span><span class="hl-7">//     r: Array&lt;string&gt;;</span><br/><span class="hl-1">  </span><span class="hl-7">//     ip: string;</span><br/><span class="hl-1">  </span><span class="hl-7">//     d?: boolean;</span><br/><span class="hl-1">  </span><span class="hl-7">//     u?: {</span><br/><span class="hl-1">  </span><span class="hl-7">//         sid: string;</span><br/><span class="hl-1">  </span><span class="hl-7">//         id: string;</span><br/><span class="hl-1">  </span><span class="hl-7">//         r: Array&lt;string&gt;;</span><br/><span class="hl-1">  </span><span class="hl-7">//         s?: Array&lt;string&gt; | null;</span><br/><span class="hl-1">  </span><span class="hl-7">//     };</span><br/><span class="hl-1">  </span><span class="hl-7">// };</span><br/><span class="hl-1">  </span><span class="hl-7">// export type ReqInfoBitwise = {</span><br/><span class="hl-1">  </span><span class="hl-7">//     t: 1;</span><br/><span class="hl-1">  </span><span class="hl-7">//     c: string;</span><br/><span class="hl-1">  </span><span class="hl-7">//     a: boolean;</span><br/><span class="hl-1">  </span><span class="hl-7">//     r: number;</span><br/><span class="hl-1">  </span><span class="hl-7">//     ip: string;</span><br/><span class="hl-1">  </span><span class="hl-7">//     d?: boolean;</span><br/><span class="hl-1">  </span><span class="hl-7">//     u?: null | {</span><br/><span class="hl-1">  </span><span class="hl-7">//         sid: string;</span><br/><span class="hl-1">  </span><span class="hl-7">//         id: string;</span><br/><span class="hl-1">  </span><span class="hl-7">//         r: number;</span><br/><span class="hl-1">  </span><span class="hl-7">//         s?: number | null;</span><br/><span class="hl-1">  </span><span class="hl-7">//     };</span><br/><span class="hl-1">  </span><span class="hl-7">// };</span><br/><span class="hl-1">  </span><span class="hl-7">// export type ReqInfo = ReqInfoString | ReqInfoBitwise;</span><br/><span class="hl-1">  </span><span class="hl-7">//</span><br/><br/><span class="hl-1">  </span><span class="hl-2">const</span><span class="hl-1"> </span><span class="hl-5">text</span><span class="hl-1">: </span><span class="hl-8">Array</span><span class="hl-1">&lt;</span><span class="hl-8">string</span><span class="hl-1">&gt; = [];</span><br/><br/><span class="hl-1">  </span><span class="hl-3">text</span><span class="hl-1">.</span><span class="hl-6">push</span><span class="hl-1">(</span><span class="hl-4">`The client ID used for this request is </span><span class="hl-2">${</span><span class="hl-3">req</span><span class="hl-9">.</span><span class="hl-3">auth</span><span class="hl-9">.</span><span class="hl-3">c</span><span class="hl-2">}</span><span class="hl-4">`</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><span class="hl-3">text</span><span class="hl-1">.</span><span class="hl-6">push</span><span class="hl-1">(</span><span class="hl-4">`The client </span><span class="hl-2">${</span><span class="hl-3">req</span><span class="hl-9">.</span><span class="hl-3">auth</span><span class="hl-9">.</span><span class="hl-3">a</span><span class="hl-9"> </span><span class="hl-1">?</span><span class="hl-9"> </span><span class="hl-4">&quot;DID&quot;</span><span class="hl-9"> </span><span class="hl-1">:</span><span class="hl-9"> </span><span class="hl-4">&quot;DID NOT&quot;</span><span class="hl-2">}</span><span class="hl-4"> pass a valid secret`</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><span class="hl-3">text</span><span class="hl-1">.</span><span class="hl-6">push</span><span class="hl-1">(</span><span class="hl-4">`The client&#39;s roles are the following: &#39;</span><span class="hl-2">${</span><span class="hl-3">req</span><span class="hl-9">.</span><span class="hl-3">auth</span><span class="hl-9">.</span><span class="hl-3">t</span><span class="hl-9"> </span><span class="hl-1">===</span><span class="hl-9"> </span><span class="hl-10">0</span><span class="hl-9"> </span><span class="hl-1">?</span><span class="hl-9"> </span><span class="hl-3">req</span><span class="hl-9">.</span><span class="hl-3">auth</span><span class="hl-9">.</span><span class="hl-3">r</span><span class="hl-9">.</span><span class="hl-6">join</span><span class="hl-9">(</span><span class="hl-4">&quot;&#39;, &#39;&quot;</span><span class="hl-9">) </span><span class="hl-1">:</span><span class="hl-9"> </span><span class="hl-3">req</span><span class="hl-9">.</span><span class="hl-3">auth</span><span class="hl-9">.</span><span class="hl-3">r</span><span class="hl-2">}</span><span class="hl-4">&#39;`</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><span class="hl-3">text</span><span class="hl-1">.</span><span class="hl-6">push</span><span class="hl-1">(</span><span class="hl-4">`The IP address of the request is </span><span class="hl-2">${</span><span class="hl-3">req</span><span class="hl-9">.</span><span class="hl-3">auth</span><span class="hl-9">.</span><span class="hl-3">ip</span><span class="hl-2">}</span><span class="hl-4">`</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><span class="hl-3">text</span><span class="hl-1">.</span><span class="hl-6">push</span><span class="hl-1">(</span><span class="hl-4">`Debugging is </span><span class="hl-2">${</span><span class="hl-3">req</span><span class="hl-9">.</span><span class="hl-3">auth</span><span class="hl-9">.</span><span class="hl-3">d</span><span class="hl-9"> </span><span class="hl-1">?</span><span class="hl-9"> </span><span class="hl-4">&quot;ON&quot;</span><span class="hl-9"> </span><span class="hl-1">:</span><span class="hl-9"> </span><span class="hl-4">&quot;OFF&quot;</span><span class="hl-2">}</span><span class="hl-4"> for this request.`</span><span class="hl-1">);</span><br/><br/><span class="hl-1">  </span><span class="hl-0">if</span><span class="hl-1"> (</span><span class="hl-3">req</span><span class="hl-1">.</span><span class="hl-3">auth</span><span class="hl-1">.</span><span class="hl-3">u</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-3">text</span><span class="hl-1">.</span><span class="hl-6">push</span><span class="hl-1">(</span><span class="hl-4">`This request is from a logged in user.`</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><span class="hl-3">text</span><span class="hl-1">.</span><span class="hl-6">push</span><span class="hl-1">(</span><span class="hl-4">`The user&#39;s id is </span><span class="hl-2">${</span><span class="hl-3">req</span><span class="hl-9">.</span><span class="hl-3">auth</span><span class="hl-9">.</span><span class="hl-3">u</span><span class="hl-9">.</span><span class="hl-3">id</span><span class="hl-2">}</span><span class="hl-4">`</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><span class="hl-3">text</span><span class="hl-1">.</span><span class="hl-6">push</span><span class="hl-1">(</span><span class="hl-4">`The user&#39;s session id for this session is </span><span class="hl-2">${</span><span class="hl-3">req</span><span class="hl-9">.</span><span class="hl-3">auth</span><span class="hl-9">.</span><span class="hl-3">u</span><span class="hl-9">.</span><span class="hl-3">sid</span><span class="hl-2">}</span><span class="hl-4">`</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><span class="hl-3">text</span><span class="hl-1">.</span><span class="hl-6">push</span><span class="hl-1">(</span><span class="hl-4">`The user&#39;s roles are the following: &#39;</span><span class="hl-2">${</span><span class="hl-3">req</span><span class="hl-9">.</span><span class="hl-3">auth</span><span class="hl-9">.</span><span class="hl-3">t</span><span class="hl-9"> </span><span class="hl-1">===</span><span class="hl-9"> </span><span class="hl-10">0</span><span class="hl-9"> </span><span class="hl-1">?</span><span class="hl-9"> </span><span class="hl-3">req</span><span class="hl-9">.</span><span class="hl-3">auth</span><span class="hl-9">.</span><span class="hl-3">u</span><span class="hl-9">.</span><span class="hl-3">r</span><span class="hl-9">.</span><span class="hl-6">join</span><span class="hl-9">(</span><span class="hl-4">&quot;&#39;, &#39;&quot;</span><span class="hl-9">) </span><span class="hl-1">:</span><span class="hl-9"> </span><span class="hl-3">req</span><span class="hl-9">.</span><span class="hl-3">auth</span><span class="hl-9">.</span><span class="hl-3">u</span><span class="hl-9">.</span><span class="hl-3">r</span><span class="hl-2">}</span><span class="hl-4">&#39;`</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><span class="hl-0">if</span><span class="hl-1"> (</span><span class="hl-3">req</span><span class="hl-1">.</span><span class="hl-3">auth</span><span class="hl-1">.</span><span class="hl-3">u</span><span class="hl-1">.</span><span class="hl-3">s</span><span class="hl-1">) {</span><br/><span class="hl-1">      </span><span class="hl-3">text</span><span class="hl-1">.</span><span class="hl-6">push</span><span class="hl-1">(</span><span class="hl-4">`This is a 3rd-party OAUTH request on behalf of the given user.`</span><span class="hl-1">);</span><br/><span class="hl-1">      </span><span class="hl-3">text</span><span class="hl-1">.</span><span class="hl-6">push</span><span class="hl-1">(</span><span class="hl-4">`The OAuth scopes for this request are: &#39;</span><span class="hl-2">${</span><span class="hl-3">req</span><span class="hl-9">.</span><span class="hl-3">auth</span><span class="hl-9">.</span><span class="hl-3">t</span><span class="hl-9"> </span><span class="hl-1">===</span><span class="hl-9"> </span><span class="hl-10">0</span><span class="hl-9"> </span><span class="hl-1">?</span><span class="hl-9"> </span><span class="hl-3">req</span><span class="hl-9">.</span><span class="hl-3">auth</span><span class="hl-9">.</span><span class="hl-3">u</span><span class="hl-9">.</span><span class="hl-3">s</span><span class="hl-9">.</span><span class="hl-6">join</span><span class="hl-9">(</span><span class="hl-4">&quot;&#39;, &#39;&quot;</span><span class="hl-9">) </span><span class="hl-1">:</span><span class="hl-9"> </span><span class="hl-3">req</span><span class="hl-9">.</span><span class="hl-3">auth</span><span class="hl-9">.</span><span class="hl-3">u</span><span class="hl-9">.</span><span class="hl-3">s</span><span class="hl-2">}</span><span class="hl-4">&#39;`</span><span class="hl-1">);</span><br/><span class="hl-1">    } </span><span class="hl-0">else</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><span class="hl-3">text</span><span class="hl-1">.</span><span class="hl-6">push</span><span class="hl-1">(</span><span class="hl-4">`This is NOT an oauth request.`</span><span class="hl-1">);</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">  } </span><span class="hl-0">else</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-3">text</span><span class="hl-1">.</span><span class="hl-6">push</span><span class="hl-1">(</span><span class="hl-4">`This request does NOT have a logged in user associated with it.`</span><span class="hl-1">);</span><br/><span class="hl-1">  }</span><br/><br/><span class="hl-1">  </span><span class="hl-3">res</span><span class="hl-1">.</span><span class="hl-6">set</span><span class="hl-1">(</span><span class="hl-4">&quot;Content-Type&quot;</span><span class="hl-1">, </span><span class="hl-4">&quot;text/plain&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><span class="hl-3">res</span><span class="hl-1">.</span><span class="hl-6">send</span><span class="hl-1">(</span><span class="hl-4">`Request Info</span><span class="hl-11">\n</span><span class="hl-4">=============================</span><span class="hl-11">\n\n</span><span class="hl-2">${</span><span class="hl-3">text</span><span class="hl-9">.</span><span class="hl-6">join</span><span class="hl-9">(</span><span class="hl-4">&quot;</span><span class="hl-11">\n</span><span class="hl-4">&quot;</span><span class="hl-9">)</span><span class="hl-2">}</span><span class="hl-4">`</span><span class="hl-1">);</span><br/><span class="hl-1">});</span>
</code></pre>
<p>Note that if you have configured your auth gateway to use a different header name, you can configure
that by passing the base header name as the second argument to the <code>getAuthGatewayHeaderDecoder</code>
function.</p>
</div></div><div class="col-4 col-menu menu-sticky-wrap menu-highlight"><nav class="tsd-navigation primary"><ul><li class="current"><a href="modules.html">Exports</a></li></ul></nav><nav class="tsd-navigation secondary menu-sticky"><ul><li class="tsd-kind-function"><a href="modules.html#getAuthGatewayHeaderDecoder" class="tsd-kind-icon">get<wbr/>Auth<wbr/>Gateway<wbr/>Header<wbr/>Decoder</a></li></ul></nav></div></div></div><footer class="with-border-bottom"><div class="container"><h2>Settings</h2><p>Theme <select id="theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></p></div></footer><div class="container tsd-generator"><p>Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></div><div class="overlay"></div><script src="assets/main.js"></script></body></html>